import random
import time
import sys

# ---------------------------------------
# KLASA POSTACI
# ---------------------------------------

class Character:
    def __init__(self, name, hp, attack, defense, inventory=None, level=1, exp=0):
        self.name = name
        self.max_hp = hp
        self.hp = hp
        self.attack = attack
        self.defense = defense
        self.inventory = inventory if inventory else []
        self.level = level
        self.exp = exp

    def is_alive(self):
        return self.hp > 0

    def take_damage(self, damage):
        damage_taken = max(0, damage - self.defense)
        self.hp -= damage_taken
        print(f"{self.name} otrzymuje {damage_taken} obra≈ºe≈Ñ! (HP: {self.hp}/{self.max_hp})")
        return damage_taken

    def attack_enemy(self, enemy):
        damage = random.randint(self.attack - 2, self.attack + 2)
        print(f"{self.name} atakuje {enemy.name} za {damage} obra≈ºe≈Ñ!")
        return enemy.take_damage(damage)

    def gain_exp(self, amount):
        print(f"{self.name} zdobywa {amount} EXP.")
        self.exp += amount
        while self.exp >= self.level * 100:
            self.exp -= self.level * 100
            self.level_up()

    def level_up(self):
        self.level += 1
        self.max_hp += 10
        self.attack += 2
        self.defense += 1
        self.hp = self.max_hp
        print(f"{self.name} awansuje na poziom {self.level}! Statystyki zwiƒôkszone.")

    def use_item(self, item_name):
        for item in self.inventory:
            if item.name == item_name:
                print(f"{self.name} u≈ºywa przedmiotu: {item.name}.")
                item.apply(self)
                self.inventory.remove(item)
                return True
        print(f"{item_name} nie znajduje siƒô w ekwipunku.")
        return False

    def show_inventory(self):
        print("Ekwipunek:")
        if not self.inventory:
            print(" (pusty)")
        for item in self.inventory:
            print(f" - {item.name}: {item.description}")


# ---------------------------------------
# KLASA PRZEDMIOT√ìW
# ---------------------------------------

class Item:
    def __init__(self, name, description, effect_function):
        self.name = name
        self.description = description
        self.effect_function = effect_function

    def apply(self, target):
        self.effect_function(target)


# ---------------------------------------
# FUNKCJE POMOCNICZE
# ---------------------------------------

def heal_20(character):
    heal_amount = min(20, character.max_hp - character.hp)
    character.hp += heal_amount
    print(f"{character.name} leczy siƒô o {heal_amount} punkt√≥w HP.")

def create_basic_items():
    potion = Item("Mikstura Leczenia", "Leczy 20 punkt√≥w HP", heal_20)
    return [potion]


# ---------------------------------------
# KLASA POTWOR√ìW
# ---------------------------------------

class Monster(Character):
    def __init__(self, name, hp, attack, defense, exp_reward):
        super().__init__(name, hp, attack, defense)
        self.exp_reward = exp_reward


# ---------------------------------------
# WALKA
# ---------------------------------------

def fight(player, monster):
    print(f"\n--- WALKA: {player.name} VS {monster.name} ---")
    while player.is_alive() and monster.is_alive():
        input("Naci≈õnij ENTER, aby zaatakowaƒá...")
        player.attack_enemy(monster)
        if monster.is_alive():
            monster.attack_enemy(player)
    if player.is_alive():
        print(f"{player.name} pokona≈Ç {monster.name}!")
        player.gain_exp(monster.exp_reward)
        return True
    else:
        print(f"{player.name} zosta≈Ç pokonany przez {monster.name}...")
        return False

# ---------------------------------------
# KLASA LOKACJI
# ---------------------------------------

class Location:
    def __init__(self, name, description, enemies=None, items=None, connected=None, quest=None):
        self.name = name
        self.description = description
        self.enemies = enemies if enemies else []
        self.items = items if items else []
        self.connected = connected if connected else {}
        self.quest = quest

    def show_info(self):
        print(f"\nüó∫Ô∏è Lokacja: {self.name}")
        print(self.description)
        if self.enemies:
            print("Wrogowie w okolicy: " + ", ".join(e.name for e in self.enemies))
        if self.items:
            print("Znalezione przedmioty: " + ", ".join(i.name for i in self.items))
        if self.quest:
            print(f"Zadanie dostƒôpne: {self.quest.name}")

# ---------------------------------------
# KLASA ZADA≈É
# ---------------------------------------

class Quest:
    def __init__(self, name, description, requirement, reward):
        self.name = name
        self.description = description
        self.requirement = requirement  # funkcja warunkowa
        self.reward = reward            # funkcja nagrody
        self.completed = False

    def try_complete(self, player):
        if not self.completed and self.requirement(player):
            print(f"\n‚úÖ Zadanie uko≈Ñczone: {self.name}")
            self.reward(player)
            self.completed = True
            return True
        return False

# ---------------------------------------
# MAPA
# ---------------------------------------

def create_world():
    # Lokacje
    village = Location(
        "Wioska Startowa",
        "Ma≈Ça wioska z kilkoma domkami i ogniskiem.",
        items=create_basic_items()
    )
    forest = Location(
        "Mroczny Las",
        "Gƒôsty, ciemny las pe≈Çen dziwnych d≈∫wiƒôk√≥w.",
        enemies=[Monster("Wilk", 20, 5, 1, 30)],
    )
    cave = Location(
        "Jaskinia Cieni",
        "Wilgotna, zimna jaskinia z echem potwor√≥w.",
        enemies=[Monster("Goblin", 30, 7, 2, 50)],
    )

    # Po≈ÇƒÖczenia
    village.connected = {"las": forest}
    forest.connected = {"wioska": village, "jaskinia": cave}
    cave.connected = {"las": forest}

    # Zadanie w wiosce
    def requirement_kill_wolf(player):
        return player.level >= 2

    def reward_healing(player):
        potion = Item("Mocna Mikstura", "Leczy 50 HP", lambda c: setattr(c, 'hp', min(c.max_hp, c.hp + 50)))
        player.inventory.append(potion)
        print("Otrzymano: Mocna Mikstura!")

    village.quest = Quest(
        "Zosta≈Ñ Bohaterem Wioski",
        "Pokonaj wroga w lesie i osiƒÖgnij poziom 2.",
        requirement_kill_wolf,
        reward_healing
    )

    return village  # poczƒÖtkowa lokacja

# ---------------------------------------
# EKSPLORACJA
# ---------------------------------------

def explore(player, location):
    while True:
        location.show_info()
        if location.quest and not location.quest.completed:
            print(f"Zadanie dostƒôpne: {location.quest.name} - {location.quest.description}")
        print("\nCo chcesz zrobiƒá?")
        print("1. Przeszukaj okolicƒô")
        print("2. Walcz z potworem")
        print("3. Przejd≈∫ do innej lokacji")
        print("4. Ekwipunek")
        print("5. U≈ºyj przedmiotu")
        print("6. Sprawd≈∫ statystyki")
        print("7. Zako≈Ñcz grƒô")

        choice = input("Wyb√≥r: ")
        if choice == "1":
            if location.items:
                item = location.items.pop()
                player.inventory.append(item)
                print(f"Znalaz≈Çe≈õ: {item.name}!")
            else:
                print("Nic ciekawego nie znalaz≈Çe≈õ.")
        elif choice == "2":
            if location.enemies:
                monster = random.choice(location.enemies)
                if fight(player, monster):
                    location.enemies.remove(monster)
                    if location.quest:
                        location.quest.try_complete(player)
                if not player.is_alive():
                    print("Koniec gry.")
                    sys.exit()
            else:
                print("Nie ma tu ≈ºadnych wrog√≥w.")
        elif choice == "3":
            if location.connected:
                print("Dostƒôpne kierunki:")
                for key in location.connected:
                    print(f"- {key}")
                dest = input("Gdzie chcesz siƒô udaƒá? ").lower()
                if dest in location.connected:
                    return location.connected[dest]
                else:
                    print("Nie mo≈ºesz tam p√≥j≈õƒá.")
            else:
                print("Brak przej≈õƒá z tej lokacji.")
        elif choice == "4":
            player.show_inventory()
        elif choice == "5":
            item_name = input("Nazwa przedmiotu do u≈ºycia: ")
            player.use_item(item_name)
        elif choice == "6":
            print(f"\nüë§ {player.name} - Poziom {player.level}")
            print(f"HP: {player.hp}/{player.max_hp} | ATK: {player.attack} | DEF: {player.defense}")
            print(f"EXP: {player.exp}/{player.level * 100}")
        elif choice == "7":
            print("Dziƒôkujemy za grƒô!")
            sys.exit()
        else:
            print("Nieznana komenda.")


# ---------------------------------------
# DIALOGI I POSTACIE NPC
# ---------------------------------------

class NPC:
    def __init__(self, name, dialog_lines, quest=None):
        self.name = name
        self.dialog_lines = dialog_lines
        self.quest = quest
        self.dialog_index = 0

    def talk(self, player):
        if self.dialog_index < len(self.dialog_lines):
            print(f"\n{self.name} m√≥wi: \"{self.dialog_lines[self.dialog_index]}\"")
            self.dialog_index += 1
        else:
            print(f"{self.name} nie ma nic wiƒôcej do powiedzenia.")
        if self.quest and not self.quest.completed:
            if self.quest.try_complete(player):
                print(f"{self.name}: Dziƒôkujƒô za pomoc!")

def add_npc_to_location(location, npc):
    if not hasattr(location, 'npcs'):
        location.npcs = []
    location.npcs.append(npc)

def interact_with_npc(location, player):
    if hasattr(location, 'npcs') and location.npcs:
        print("\nDostƒôpni NPC:")
        for idx, npc in enumerate(location.npcs):
            print(f"{idx + 1}. {npc.name}")
        choice = input("Wybierz NPC do rozmowy (numer): ")
        if choice.isdigit():
            index = int(choice) - 1
            if 0 <= index < len(location.npcs):
                npc = location.npcs[index]
                npc.talk(player)
            else:
                print("Nie ma takiego NPC.")
        else:
            print("Niepoprawny wyb√≥r.")
    else:
        print("Nie ma tu nikogo do rozmowy.")

# ---------------------------------------
# WIƒòCEJ POTWOR√ìW
# ---------------------------------------

def generate_monster(name):
    stats = {
        "Szkielet": (25, 6, 2, 40),
        "Ork": (40, 10, 3, 70),
        "Nietoperz": (15, 4, 1, 20),
        "Demon": (80, 15, 5, 150)
    }
    if name in stats:
        hp, atk, defn, exp = stats[name]
        return Monster(name, hp, atk, defn, exp)
    else:
        return Monster("Potw√≥r", 20, 5, 1, 25)

# ---------------------------------------
# TWORZENIE ≈öWIATA Z NPC
# ---------------------------------------

def build_full_world():
    start = create_world()
    forest = start.connected["las"]
    cave = forest.connected["jaskinia"]

    # Dodajemy NPC do wioski
    def quest_condition(player):
        return any(item.name == "ZƒÖb Wilka" for item in player.inventory)

    def reward_npc(player):
        print("Otrzymujesz 100 z≈Çota (niewidoczna waluta üòÖ) i szacunek mieszka≈Ñc√≥w.")
        player.gain_exp(50)

    npc_quest = Quest(
        "ZƒÖb Wilka",
        "Przynie≈õ zƒÖb wilka jako dow√≥d pokonania bestii.",
        quest_condition,
        reward_npc
    )

    elder = NPC(
        "Stary Mƒôdrzec",
        [
            "Witaj, m≈Çody podr√≥≈ºniku.",
            "Las skrywa wiele tajemnic...",
            "Uwa≈ºaj na stworzenia w jaskini."
        ],
        npc_quest
    )
    add_npc_to_location(start, elder)

    # Dodajemy nowe lokacje i potwory
    tower = Location(
        "Wie≈ºa Maga",
        "Zrujnowana wie≈ºa, w kt√≥rej kiedy≈õ mieszka≈Ç wielki czarodziej.",
        enemies=[generate_monster("Szkielet"), generate_monster("Nietoperz")]
    )
    fortress = Location(
        "Twierdza Cierni",
        "Staro≈ºytna twierdza zamieszkiwana przez potƒô≈ºnego demona.",
        enemies=[generate_monster("Demon")]
    )

    cave.connected["wie≈ºa"] = tower
    tower.connected["jaskinia"] = cave
    tower.connected["twierdza"] = fortress
    fortress.connected["wie≈ºa"] = tower

    return start

# ---------------------------------------
# START GRY
# ---------------------------------------

def start_game():
    print("===================================")
    print("       WITAJ W TEKSTOWYM RPG       ")
    print("===================================")
    name = input("Podaj imiƒô swojej postaci: ")
    player = Character(name, 100, 10, 3, inventory=create_basic_items())
    current_location = build_full_world()

    print(f"\nWitaj, {player.name}! Twoja przygoda siƒô zaczyna...\n")
    while True:
        current_location = explore(player, current_location)
        if hasattr(current_location, 'npcs'):
            interact_with_npc(current_location, player)

# ---------------------------------------
# URUCHOMIENIE GRY
# ---------------------------------------

if __name__ == "__main__":
    start_game()


# ---------------------------------------
# CRAFTING
# ---------------------------------------

class Recipe:
    def __init__(self, name, ingredients, result):
        self.name = name
        self.ingredients = ingredients  # list of item names
        self.result = result  # Item instance

def craft(player, recipes):
    print("\nüì¶ Dostƒôpne przepisy:")
    for i, recipe in enumerate(recipes):
        print(f"{i + 1}. {recipe.name} - sk≈Çadniki: {', '.join(recipe.ingredients)}")
    choice = input("Wybierz numer przepisu do stworzenia (lub ENTER, aby wyj≈õƒá): ")
    if not choice.strip():
        return
    if choice.isdigit():
        index = int(choice) - 1
        if 0 <= index < len(recipes):
            recipe = recipes[index]
            inventory_names = [item.name for item in player.inventory]
            if all(recipe.ingredients.count(ing) <= inventory_names.count(ing) for ing in recipe.ingredients):
                # usu≈Ñ sk≈Çadniki
                for ing in recipe.ingredients:
                    for item in player.inventory:
                        if item.name == ing:
                            player.inventory.remove(item)
                            break
                # dodaj wynik
                player.inventory.append(recipe.result)
                print(f"Utworzono: {recipe.result.name}")
            else:
                print("Brakuje sk≈Çadnik√≥w!")
        else:
            print("Nieprawid≈Çowy wyb√≥r.")
    else:
        print("B≈ÇƒÖd formatu.")

def create_recipes():
    super_potion = Item("Super Mikstura", "Leczy 80 HP", lambda c: setattr(c, 'hp', min(c.max_hp, c.hp + 80)))
    return [
        Recipe("Super Mikstura", ["Mikstura Leczenia", "Mikstura Leczenia"], super_potion)
    ]

# ---------------------------------------
# DRU≈ªYNA
# ---------------------------------------

class Ally(Character):
    def __init__(self, name, hp, attack, defense):
        super().__init__(name, hp, attack, defense)

def group_fight(player, allies, monster):
    print(f"\nü§ù WALKA DRU≈ªYNOWA: {player.name} + sojusznicy VS {monster.name}")
    while player.is_alive() and monster.is_alive():
        input("ENTER, aby rozpoczƒÖƒá turƒô walki...")
        participants = [player] + allies
        for member in participants:
            if monster.is_alive():
                member.attack_enemy(monster)
        if monster.is_alive():
            target = random.choice(participants)
            monster.attack_enemy(target)
        if not player.is_alive():
            print("Gracz poleg≈Ç. Koniec gry.")
            sys.exit()
    print(f"{monster.name} zosta≈Ç pokonany!")
    player.gain_exp(monster.exp_reward)

# ---------------------------------------
# NOWE ZADANIE Z CRAFTINGU
# ---------------------------------------

def create_crafting_quest():
    def condition(player):
        return any(item.name == "Super Mikstura" for item in player.inventory)
    
    def reward(player):
        player.gain_exp(75)
        print("Nagroda: 75 EXP i szacunek alchemik√≥w.")

    return Quest(
        "Tajemna Mikstura",
        "Stw√≥rz Super Miksturƒô poprzez crafting.",
        condition,
        reward
    )

# ---------------------------------------
# DODANIE NOWEJ LOKACJI I SOJUSZNIK√ìW
# ---------------------------------------

def extend_world_with_tower(start_location):
    tower = start_location.connected["las"].connected["jaskinia"].connected["wie≈ºa"]
    lab = Location(
        "Laboratorium Alchemika",
        "Stare laboratorium pe≈Çne mikstur i dziwnych urzƒÖdze≈Ñ.",
        items=[Item("Mikstura Leczenia", "Leczy 20 HP", heal_20)]
    )
    tower.connected["laboratorium"] = lab
    lab.connected["wie≈ºa"] = tower

    alchemist = NPC(
        "Stary Alchemik",
        [
            "Przyby≈Çe≈õ, by poznaƒá tajemnice mikstur?",
            "Zbieraj sk≈Çadniki i pr√≥buj tworzyƒá co≈õ nowego..."
        ],
        create_crafting_quest()
    )
    add_npc_to_location(lab, alchemist)

    # Sojusznik
    companion = Ally("Stra≈ºnik Wie≈ºy", 80, 12, 4)
    lab.ally = companion

# ---------------------------------------
# ZMIANY W EKSPLORACJI DLA CRAFTINGU I SOJUSZNIKA
# ---------------------------------------

def explore(player, location):
    recipes = create_recipes()
    ally_added = False

    while True:
        location.show_info()
        if hasattr(location, 'npcs'):
            print("NPC sƒÖ dostƒôpni.")
        if hasattr(location, 'ally') and not ally_added:
            print(f"Sojusznik {location.ally.name} do≈ÇƒÖcza do dru≈ºyny!")
            ally = location.ally
            ally_added = True
        else:
            ally = None

        print("\nCo chcesz zrobiƒá?")
        print("1. Przeszukaj okolicƒô")
        print("2. Walcz z potworem")
        print("3. Przejd≈∫ do innej lokacji")
        print("4. Ekwipunek")
        print("5. U≈ºyj przedmiotu")
        print("6. Sprawd≈∫ statystyki")
        print("7. Porozmawiaj z NPC")
        print("8. Crafting")
        print("9. Zako≈Ñcz grƒô")

        choice = input("Wyb√≥r: ")
        if choice == "1":
            if location.items:
                item = location.items.pop()
                player.inventory.append(item)
                print(f"Znalaz≈Çe≈õ: {item.name}!")
            else:
                print("Nic ciekawego nie znalaz≈Çe≈õ.")
        elif choice == "2":
            if location.enemies:
                monster = random.choice(location.enemies)
                if ally:
                    group_fight(player, [ally], monster)
                else:
                    fight(player, monster)
                location.enemies.remove(monster)
            else:
                print("Nie ma tu ≈ºadnych wrog√≥w.")
        elif choice == "3":
            if location.connected:
                print("Dostƒôpne przej≈õcia:")
                for key in location.connected:
                    print(f"- {key}")
                dest = input("DokƒÖd idziesz? ").lower()
                if dest in location.connected:
                    return location.connected[dest]
                else:
                    print("Nie mo≈ºesz tam p√≥j≈õƒá.")
            else:
                print("Brak przej≈õƒá.")
        elif choice == "4":
            player.show_inventory()
        elif choice == "5":
            item_name = input("Nazwa przedmiotu do u≈ºycia: ")
            player.use_item(item_name)
        elif choice == "6":
            print(f"{player.name} - Poziom {player.level} | HP: {player.hp}/{player.max_hp}")
            print(f"ATK: {player.attack}, DEF: {player.defense}, EXP: {player.exp}/{player.level * 100}")
        elif choice == "7":
            interact_with_npc(location, player)
        elif choice == "8":
            craft(player, recipes)
        elif choice == "9":
            print("Do zobaczenia!")
            sys.exit()
        else:
            print("Nieznana komenda.")


# ---------------------------------------
# BOSS I FINA≈Å
# ---------------------------------------

class FinalBoss(Monster):
    def __init__(self):
        super().__init__("Kr√≥l Demon√≥w", 200, 20, 10, 500)

def add_final_boss_area(start_location):
    fortress = start_location.connected["las"].connected["jaskinia"].connected["wie≈ºa"].connected["twierdza"]
    throne = Location(
        "Sala Tronowa",
        "Mroczna komnata, w kt√≥rej czeka Kr√≥l Demon√≥w. To miejsce przesycone jest z≈Çem.",
        enemies=[FinalBoss()]
    )
    fortress.connected["tron"] = throne
    throne.connected["twierdza"] = fortress
    return throne

# ---------------------------------------
# SYSTEM ZAKO≈ÉCZE≈É
# ---------------------------------------

def check_ending(player):
    print("\nüéâ Gratulacje! Pokona≈Çe≈õ Kr√≥la Demon√≥w i oczy≈õci≈Çe≈õ krainƒô ze z≈Ça.")
    print("Twoje osiƒÖgniƒôcia:")
    print(f"- Poziom: {player.level}")
    print(f"- EXP: {player.exp}")
    print(f"- Liczba przedmiot√≥w w ekwipunku: {len(player.inventory)}")
    print(f"- Liczba uko≈Ñczonych zada≈Ñ: {sum(1 for quest in completed_quests if quest)}")

    if player.level >= 6:
        print("\nüèÜ Zako≈Ñczenie: Bohater Legendarny")
        print("Twoje imiƒô bƒôdzie wspominane przez pokolenia.")
    elif player.level >= 4:
        print("\nüèÜ Zako≈Ñczenie: Obro≈Ñca Krainy")
        print("Oczy≈õci≈Çe≈õ ziemie, ale czeka Ciƒô jeszcze wiele przyg√≥d.")
    else:
        print("\nüèÜ Zako≈Ñczenie: Niedosz≈Çy Bohater")
        print("Uda≈Ço siƒô... ale z trudem. Twoja legenda dopiero siƒô tworzy.")

    print("\nDziƒôkujemy za grƒô!")

# ---------------------------------------
# ZMIANY W explore() DLA FINA≈ÅU
# ---------------------------------------

completed_quests = []

def explore(player, location):
    recipes = create_recipes()
    ally_added = False
    ally = None

    while True:
        location.show_info()
        if hasattr(location, 'npcs'):
            print("NPC sƒÖ dostƒôpni.")
        if hasattr(location, 'ally') and not ally_added:
            print(f"Sojusznik {location.ally.name} do≈ÇƒÖcza do dru≈ºyny!")
            ally = location.ally
            ally_added = True

        print("\nCo chcesz zrobiƒá?")
        print("1. Przeszukaj okolicƒô")
        print("2. Walcz z potworem")
        print("3. Przejd≈∫ do innej lokacji")
        print("4. Ekwipunek")
        print("5. U≈ºyj przedmiotu")
        print("6. Statystyki")
        print("7. Rozmowa z NPC")
        print("8. Crafting")
        print("9. Zako≈Ñcz grƒô")

        choice = input("Wyb√≥r: ")
        if choice == "1":
            if location.items:
                item = location.items.pop()
                player.inventory.append(item)
                print(f"Znalaz≈Çe≈õ: {item.name}!")
            else:
                print("Nic nie znalaz≈Çe≈õ.")
        elif choice == "2":
            if location.enemies:
                monster = location.enemies[0]
                print(f"üõ°Ô∏è Walka z: {monster.name}")
                if isinstance(monster, FinalBoss):
                    if ally:
                        group_fight(player, [ally], monster)
                    else:
                        fight(player, monster)
                    if not monster.is_alive():
                        location.enemies.remove(monster)
                        check_ending(player)
                        sys.exit()
                else:
                    if ally:
                        group_fight(player, [ally], monster)
                    else:
                        fight(player, monster)
                    location.enemies.remove(monster)
            else:
                print("Brak wrog√≥w.")
        elif choice == "3":
            if location.connected:
                print("Dostƒôpne przej≈õcia:")
                for key in location.connected:
                    print(f"- {key}")
                dest = input("Gdzie idziesz? ").lower()
                if dest in location.connected:
                    return location.connected[dest]
                else:
                    print("Nieznana lokacja.")
            else:
                print("Brak przej≈õƒá.")
        elif choice == "4":
            player.show_inventory()
        elif choice == "5":
            item_name = input("Nazwa przedmiotu: ")
            player.use_item(item_name)
        elif choice == "6":
            print(f"{player.name} - Poziom {player.level} | HP: {player.hp}/{player.max_hp}")
            print(f"ATK: {player.attack}, DEF: {player.defense}, EXP: {player.exp}/{player.level * 100}")
        elif choice == "7":
            interact_with_npc(location, player)
        elif choice == "8":
            craft(player, recipes)
        elif choice == "9":
            print("Zako≈Ñczono grƒô.")
            sys.exit()
        else:
            print("Niepoprawny wyb√≥r.")

# ---------------------------------------
# OSTATECZNE URUCHOMIENIE GRY
# ---------------------------------------

def start_game():
    print("===================================")
    print("       WITAJ W TEKSTOWYM RPG       ")
    print("===================================")
    name = input("Podaj imiƒô bohatera: ")
    player = Character(name, 100, 10, 3, inventory=create_basic_items())
    current_location = build_full_world()
    extend_world_with_tower(current_location)
    final_area = add_final_boss_area(current_location)

    print(f"\nWitaj, {player.name}! Czeka Ciƒô przygoda pe≈Çna niebezpiecze≈Ñstw...\n")
    while True:
        current_location = explore(player, current_location)

if __name__ == "__main__":
    start_game()


# ---------------------------------------
# SYSTEM UZBROJENIA I ZBROI
# ---------------------------------------

class Equipment(Item):
    def __init__(self, name, description, slot, bonus_attack=0, bonus_defense=0):
        super().__init__(name, description)
        self.slot = slot  # "weapon" lub "armor"
        self.bonus_attack = bonus_attack
        self.bonus_defense = bonus_defense

def create_equipment_items():
    return [
        Equipment("Miecz Wojownika", "Silny miecz (+5 ATK)", "weapon", bonus_attack=5),
        Equipment("Top√≥r Bitwy", "Ciƒô≈ºki top√≥r (+8 ATK)", "weapon", bonus_attack=8),
        Equipment("Sk√≥rzana Zbroja", "Lekka zbroja (+3 DEF)", "armor", bonus_defense=3),
        Equipment("Pancerz Rycerza", "Ciƒô≈ºka zbroja (+6 DEF)", "armor", bonus_defense=6),
    ]

# Dodajemy nowy atrybut do postaci
Character.equipment = {"weapon": None, "armor": None}

def get_equipped_stats(player):
    bonus_atk = player.attack
    bonus_def = player.defense
    weapon = player.equipment["weapon"]
    armor = player.equipment["armor"]

    if weapon:
        bonus_atk += weapon.bonus_attack
    if armor:
        bonus_def += armor.bonus_defense

    return bonus_atk, bonus_def

# Modyfikacja metody ataku
def new_attack_enemy(self, enemy):
    atk, _ = get_equipped_stats(self)
    damage = max(atk - enemy.defense, 0)
    print(f"{self.name} atakuje {enemy.name} z si≈ÇƒÖ {atk}. Zadano {damage} obra≈ºe≈Ñ.")
    enemy.hp -= damage

Character.attack_enemy = new_attack_enemy

# Zmieniona walka potwora
def new_monster_attack(self, target):
    _, defn = get_equipped_stats(target)
    damage = max(self.attack - defn, 0)
    print(f"{self.name} atakuje {target.name} z si≈ÇƒÖ {self.attack}. Zadano {damage} obra≈ºe≈Ñ.")
    target.hp -= damage

Monster.attack_enemy = new_monster_attack

# ---------------------------------------
# EKWIPUNEK ‚Äì ZAK≈ÅADANIE PRZEDMIOT√ìW
# ---------------------------------------

def equip_item(player):
    weapons = [item for item in player.inventory if isinstance(item, Equipment)]
    if not weapons:
        print("Nie masz ≈ºadnego sprzƒôtu do za≈Ço≈ºenia.")
        return

    print("\nüîß Dostƒôpne wyposa≈ºenie:")
    for i, item in enumerate(weapons):
        print(f"{i + 1}. {item.name} ({item.slot.upper()})")

    choice = input("Wybierz numer przedmiotu do za≈Ço≈ºenia: ")
    if choice.isdigit():
        index = int(choice) - 1
        if 0 <= index < len(weapons):
            item = weapons[index]
            player.equipment[item.slot] = item
            print(f"{item.name} zosta≈Ç za≈Ço≈ºony jako {item.slot}.")
        else:
            print("Nieprawid≈Çowy wyb√≥r.")
    else:
        print("B≈Çƒôdny format.")


# ---------------------------------------
# SYSTEM TALENT√ìW (ZDOLNO≈öCI)
# ---------------------------------------

class Talent:
    def __init__(self, name, description, effect):
        self.name = name
        self.description = description
        self.effect = effect  # funkcja wywo≈Çywana na postaci

def heal_boost(player):
    player.hp = min(player.max_hp, player.hp + 50)
    print(f"{player.name} u≈ºywa zdolno≈õci: Leczenie (+50 HP)!")

def rage_boost(player):
    player.attack += 5
    print(f"{player.name} wpada w sza≈Ç! ATK zwiƒôkszone o 5 na tƒô walkƒô.")

def create_talents():
    return [
        Talent("Szybkie Leczenie", "Natychmiastowo przywraca 50 HP", heal_boost),
        Talent("Sza≈Ç Bojowy", "Zwiƒôksza ATK o 5 na jednƒÖ walkƒô", rage_boost)
    ]

Character.talents = []
Character.used_talents = []

def use_talent(player):
    if not player.talents:
        print("Brak dostƒôpnych talent√≥w.")
        return
    print("\nüß† Twoje zdolno≈õci:")
    for i, t in enumerate(player.talents):
        print(f"{i + 1}. {t.name} - {t.description}")
    choice = input("Wybierz talent do u≈ºycia: ")
    if choice.isdigit():
        index = int(choice) - 1
        if 0 <= index < len(player.talents):
            talent = player.talents[index]
            if talent.name in player.used_talents:
                print("Ten talent ju≈º zosta≈Ç u≈ºyty w tej walce.")
            else:
                talent.effect(player)
                player.used_talents.append(talent.name)
        else:
            print("Nieprawid≈Çowy wyb√≥r.")
    else:
        print("B≈ÇƒÖd formatu.")

# Resetowanie u≈ºycia talent√≥w po walce
def reset_talents(player):
    player.used_talents = []

# ---------------------------------------
# DZIENNIK POSTACI
# ---------------------------------------

Character.journal = []

def log_event(player, text):
    entry = f"[{time.strftime('%H:%M:%S')}] {text}"
    player.journal.append(entry)

def show_journal(player):
    print("\nüìò Dziennik postaci:")
    if not player.journal:
        print("Brak zapisanych wydarze≈Ñ.")
    else:
        for line in player.journal[-10:]:
            print(line)

# ---------------------------------------
# SYSTEM MINI-MAPY
# ---------------------------------------

Character.position = "start"

def show_map(player):
    print("\nüó∫Ô∏è Mini-Mapa:")
    print(f"Obecna lokacja: {player.position}")
    print("Legenda: start, las, jaskinia, wie≈ºa, twierdza, tron")
    print("Poruszaj siƒô po ≈õwiecie i odkrywaj kolejne miejsca!")

# ---------------------------------------
# LOSOWE WYDARZENIA
# ---------------------------------------

def random_event(player):
    events = [
        "Spotykasz wƒôdrowca, kt√≥ry daje ci miksturƒô.",
        "Napotykasz pu≈Çapkƒô ‚Äì tracisz 10 HP!",
        "Odnajdujesz ukryty skarb ‚Äì +100 EXP!",
        "Nic siƒô nie wydarzy≈Ço..."
    ]
    choice = random.choice(events)
    print(f"üîÆ Wydarzenie: {choice}")
    if "miksturƒô" in choice:
        player.inventory.append(HealingPotion())
    elif "pu≈Çapkƒô" in choice:
        player.hp = max(player.hp - 10, 0)
    elif "skarb" in choice:
        player.gain_exp(100)

# ---------------------------------------
# INTEGRACJA NOWYCH FUNKCJI DO explore()
# ---------------------------------------

def explore(player, location):
    recipes = create_recipes()
    ally_added = False
    ally = None

    player.position = location.name
    log_event(player, f"Odwiedzono lokacjƒô: {location.name}")
    random_event(player)

    while True:
        location.show_info()
        print("\nCo chcesz zrobiƒá?")
        print("1. Przeszukaj okolicƒô")
        print("2. Walcz z potworem")
        print("3. Przejd≈∫ do innej lokacji")
        print("4. Ekwipunek")
        print("5. U≈ºyj przedmiotu")
        print("6. Statystyki")
        print("7. Rozmowa z NPC")
        print("8. Crafting")
        print("9. Zdolno≈õƒá specjalna")
        print("10. Za≈Ç√≥≈º sprzƒôt")
        print("11. Poka≈º mapƒô")
        print("12. Dziennik")
        print("13. Zako≈Ñcz grƒô")

        choice = input("Wyb√≥r: ")
        if choice == "1":
            if location.items:
                item = location.items.pop()
                player.inventory.append(item)
                print(f"Znalaz≈Çe≈õ: {item.name}!")
                log_event(player, f"Znaleziono przedmiot: {item.name}")
            else:
                print("Nic nie znalaz≈Çe≈õ.")
        elif choice == "2":
            if location.enemies:
                monster = location.enemies[0]
                print(f"üõ°Ô∏è Walka z: {monster.name}")
                if ally:
                    group_fight(player, [ally], monster)
                else:
                    fight(player, monster)
                if not monster.is_alive():
                    location.enemies.remove(monster)
                    log_event(player, f"Pokonano potwora: {monster.name}")
                reset_talents(player)
            else:
                print("Brak wrog√≥w.")
        elif choice == "3":
            if location.connected:
                print("Dostƒôpne przej≈õcia:")
                for key in location.connected:
                    print(f"- {key}")
                dest = input("Gdzie idziesz? ").lower()
                if dest in location.connected:
                    return location.connected[dest]
                else:
                    print("Nieznana lokacja.")
            else:
                print("Brak przej≈õƒá.")
        elif choice == "4":
            player.show_inventory()
        elif choice == "5":
            item_name = input("Nazwa przedmiotu: ")
            player.use_item(item_name)
        elif choice == "6":
            atk, defn = get_equipped_stats(player)
            print(f"{player.name} - Poziom {player.level} | HP: {player.hp}/{player.max_hp}")
            print(f"ATK: {atk}, DEF: {defn}, EXP: {player.exp}/{player.level * 100}")
        elif choice == "7":
            interact_with_npc(location, player)
        elif choice == "8":
            craft(player, recipes)
        elif choice == "9":
            use_talent(player)
        elif choice == "10":
            equip_item(player)
        elif choice == "11":
            show_map(player)
        elif choice == "12":
            show_journal(player)
        elif choice == "13":
            print("Zako≈Ñczono grƒô.")
            sys.exit()
        else:
            print("Niepoprawny wyb√≥r.")
